<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Distribuição de Mídias</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.4;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(29, 78, 216, 0.2);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            margin: 15px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 3px solid #1d4ed8;
        }
        
        .stat-number {
            font-size: 20px;
            font-weight: 700;
            color: #1e3a8a;
            display: block;
        }
        
        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 3px;
        }
        
        .calendar-compact {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .month-header {
            background: #1e3a8a;
            color: white;
            padding: 12px;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .calendar-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .calendar-table th {
            background: #e5e7eb;
            padding: 8px 4px;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: #374151;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .calendar-table td {
            padding: 6px 4px;
            text-align: center;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
            height: 50px;
            position: relative;
            min-width: 45px;
        }
        
        .date-cell {
            font-size: 12px;
            color: #6b7280;
            position: relative;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding-top: 2px;
        }
        
        .date-cell.current-month {
            color: #374151;
            font-weight: 500;
        }
        
        .date-cell.has-spots {
            background: #dbeafe;
            color: #1e40af;
            font-weight: 700;
            border-radius: 4px;
        }
        
        .date-cell.selected-weekday {
            background: #f3f4f6;
        }
        
        .date-number {
            font-size: 12px;
            line-height: 1;
            margin-bottom: 2px;
        }

        .spots-container {
            position: absolute;
            top: 0;
            right: 0;
            left: 0;
            bottom: 18px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: flex-end;
            padding: 2px;
            pointer-events: none;
        }

        .spots-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            max-width: 100%;
            justify-content: flex-end;
            align-content: flex-start;
            pointer-events: auto;
        }

        .consolidated-badge {
            background: linear-gradient(135deg, #1d4ed8, #7c3aed);
            font-size: 8px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            cursor: help;
            position: relative;
            animation: pulse 2s infinite;
            box-shadow: 0 2px 6px rgba(29, 78, 216, 0.3);
            border: 2px solid rgba(255,255,255,0.2);
        }

        .consolidated-badge:hover {
            transform: scale(1.15);
            box-shadow: 0 4px 12px rgba(29, 78, 216, 0.4);
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(29, 78, 216, 0.4); }
            50% { box-shadow: 0 0 0 4px rgba(29, 78, 216, 0.1); }
        }

        .export-btn {
            background: linear-gradient(135deg, #059669, #10b981);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(5, 150, 105, 0.2);
            margin-left: 8px;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #047857, #059669);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(5, 150, 105, 0.3);
        }

        .export-btn.calendar {
            background: linear-gradient(135deg, #dc2626, #ef4444);
            box-shadow: 0 2px 4px rgba(220, 38, 38, 0.2);
        }

        .export-btn.calendar:hover {
            background: linear-gradient(135deg, #b91c1c, #dc2626);
            box-shadow: 0 4px 8px rgba(220, 38, 38, 0.3);
        }

        .impact-stat {
            border-left: 3px solid #10b981;
        }

        .pmm-value {
            color: #059669;
            font-weight: 700;
        }
        
        .weekdays-info {
            background: #f8fafc;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 3px solid #1d4ed8;
        }
        
        .weekdays-info strong {
            color: #1e3a8a;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .weekdays-list {
            color: #6b7280;
            font-size: 11px;
            margin-top: 3px;
        }

        .product-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            margin-right: 8px;
            margin-bottom: 4px;
            transition: transform 0.2s ease;
        }

        .product-tag:hover {
            transform: translateY(-1px);
        }

        .tag-spots30 { background: #1d4ed8; }
        .tag-spots5 { background: #059669; }
        .tag-spots15 { background: #dc2626; }
        .tag-spots60 { background: #7c3aed; }
        .tag-test60 { background: #ea580c; }

        .rich-tooltip {
            position: fixed;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95), rgba(31, 41, 55, 0.95));
            color: white;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 12px;
            white-space: pre-line;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.15);
            font-family: 'Arial', sans-serif;
            max-width: 280px;
            line-height: 1.4;
        }

        .rich-tooltip.show {
            opacity: 1;
            transform: translateY(-15px);
        }

        .rich-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            border: 8px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.95);
            transform: translateX(-50%);
        }

        .actions-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .actions-left {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
        }

        .actions-right {
            display: flex;
            gap: 8px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .calendar-table th,
            .calendar-table td {
                padding: 3px 2px;
                font-size: 10px;
                height: 45px;
                min-width: 35px;
            }

            .consolidated-badge {
                width: 14px;
                height: 14px;
                font-size: 6px;
            }

            .date-number {
                font-size: 10px;
            }

            .product-tag {
                font-size: 10px;
                padding: 3px 8px;
            }

            .actions-right {
                flex-direction: column;
                gap: 4px;
            }

            .export-btn {
                font-size: 10px;
                padding: 6px 12px;
                margin-left: 0;
            }
        }

        @media (max-width: 480px) {
            .calendar-table td {
                height: 40px;
                min-width: 30px;
            }

            .consolidated-badge {
                width: 12px;
                height: 12px;
                font-size: 5px;
            }
        }

        .calendar-compact {
            animation: slideInUp 0.4s ease-out;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stat-card {
            animation: fadeInScale 0.3s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="title">Distribuição de Mídias</h1>
            <p id="subtitle">Carregando informações da campanha...</p>
        </div>
        
        <div id="error-message" class="error" style="display: none;"></div>
        
        <div id="products-info" class="weekdays-info" style="display: none;">
            <div><strong>Produtos Ativos:</strong></div>
            <div class="weekdays-list" id="active-products"></div>
        </div>
        
        <div id="weekdays-info" class="weekdays-info" style="display: none;">
            <div><strong>Dias Selecionados:</strong></div>
            <div class="weekdays-list" id="selected-weekdays"></div>
        </div>
        
        <div class="actions-bar" id="actions-bar" style="display: none;">
            <div class="actions-left">
                <span id="campaign-title">Campanha Ativa</span>
            </div>
            <div class="actions-right">
                <button class="export-btn" onclick="exportToExcel()">
                    📊 Exportar Dados
                </button>
                <button class="export-btn calendar" onclick="exportCalendarToExcel()">
                    📅 Exportar Calendário
                </button>
            </div>
        </div>
        
        <div class="stats-grid" id="stats" style="display: none;">
            <div class="stat-card">
                <span class="stat-number" id="total-spots">0</span>
                <div class="stat-label">Total Inserções</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="total-days">0</span>
                <div class="stat-label">Dias Ativos</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="avg-spots">0</span>
                <div class="stat-label">Média Inserções/Dia</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="period-range">-</span>
                <div class="stat-label">Período</div>
            </div>
            <div class="stat-card impact-stat">
                <span class="stat-number pmm-value" id="total-impact">0</span>
                <div class="stat-label">Impactos Total</div>
            </div>
            <div class="stat-card impact-stat">
                <span class="stat-number pmm-value" id="pmm-used">0</span>
                <div class="stat-label">PMM Utilizado</div>
            </div>
        </div>
        
        <div id="calendar-container"></div>
    </div>

    <!-- Carregar biblioteca XLSX para exportação -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        console.log('🚀 Sistema iniciando com detecção automática de UUID Notion...');
        
        let tooltip = null;

        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            
            // Detectar se há um UUID do Notion
            const notionId = params.get('id');
            const uuidRegex = /^[0-9a-f]{32}$/i;
            
            // Se há um ID válido do Notion, usar modo API
            if (notionId && uuidRegex.test(notionId)) {
                console.log('🔍 UUID Notion detectado:', notionId);
                return {
                    mode: 'notion-api',
                    uuid: notionId,
                    // Valores padrão que serão sobrescritos pelos dados do Notion
                    spots30: 0,
                    spots5: 0,
                    spots15: 0,
                    spots60: 0,
                    test60: 0,
                    emissora: 'Carregando...',
                    inicio: '01/01/2025',
                    fim: '31/01/2025',
                    dias: 'Seg.,Ter.,Qua.,Qui.,Sex.',
                    pmm: 1000
                };
            }
            
            // Modo legado: usar parâmetros individuais da URL
            console.log('📋 Usando modo legado com parâmetros da URL');
            return {
                mode: 'legacy',
                spots30: parseInt(params.get('spots30')) || 0,
                spots5: parseInt(params.get('spots5')) || 0,
                spots15: parseInt(params.get('spots15')) || 0,
                spots60: parseInt(params.get('spots60')) || 0,
                test60: parseInt(params.get('test60')) || 0,
                emissora: params.get('emissora') || 'Emissora',
                inicio: params.get('inicio') || '01/10/2025',
                fim: params.get('fim') || '31/10/2025',
                dias: params.get('dias') || 'Seg.,Ter.,Qua.,Qui.,Sex.',
                pmm: parseInt(params.get('pmm')) || 1000
            };
        }

        async function fetchNotionData(uuid) {
            console.log('🚀 Buscando dados do Notion para UUID:', uuid);
            
            try {
                // Usar o endpoint correto da função Netlify
                const response = await fetch(`/.netlify/functions/notion?id=${uuid}`);
                console.log('📡 Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Erro na resposta:', errorText);
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('✅ Dados recebidos do Notion:', data);
                return data;
                
            } catch (error) {
                console.error('❌ Erro ao buscar dados do Notion:', error);
                throw error;
            }
        }

        function getActiveProducts(params) {
            const products = {
                spots30: params.spots30,
                spots5: params.spots5,
                spots15: params.spots15,
                spots60: params.spots60,
                test60: params.test60
            };
            
            return Object.fromEntries(
                Object.entries(products).filter(([_, value]) => value > 0)
            );
        }

        function getProductName(productType) {
            const productNames = {
                'spots30': 'Spots 30"',
                'spots5': 'Spots 5"', 
                'spots15': 'Spots 15"',
                'spots60': 'Spots 60"',
                'test60': 'Test. 60"'
            };
            return productNames[productType] || productType;
        }

        function getProductColor(productType) {
            const colors = {
                'spots30': '#1d4ed8',
                'spots5': '#059669',
                'spots15': '#dc2626', 
                'spots60': '#7c3aed',
                'test60': '#ea580c'
            };
            return colors[productType] || '#6b7280';
        }

        function parseDate(dateStr) {
            const [day, month, year] = dateStr.split('/');
            return new Date(year, month - 1, day);
        }

        function formatDate(date) {
            return date.toLocaleDateString('pt-BR');
        }

        function parseSelectedWeekdays(diasStr) {
            const mapping = {
                'Dom.': 0, 'Seg.': 1, 'Ter.': 2, 'Qua.': 3, 
                'Qui.': 4, 'Sex.': 5, 'Sáb.': 6
            };
            
            return diasStr.split(',').map(day => mapping[day.trim()]).filter(d => d !== undefined);
        }

        function isDaySelected(date, selectedWeekdays) {
            return selectedWeekdays.includes(date.getDay());
        }

        function getValidDays(startDate, endDate, selectedWeekdays) {
            const validDays = [];
            const current = new Date(startDate);
            
            while (current <= endDate) {
                if (isDaySelected(current, selectedWeekdays)) {
                    validDays.push(new Date(current));
                }
                current.setDate(current.getDate() + 1);
            }
            
            return validDays;
        }

        function distributeMultipleSpots(products, validDays) {
            const totalSpots = Object.values(products).reduce((sum, spots) => sum + spots, 0);
            
            if (totalSpots === 0) {
                return { distribution: {}, totalSpots: 0 };
            }
            
            const distribution = {};
            const productEntries = Object.entries(products);
            
            validDays.forEach(day => {
                const dateKey = day.toISOString().split('T')[0];
                distribution[dateKey] = { total: 0, products: {} };
            });
            
            productEntries.forEach(([productType, totalSpotsForProduct]) => {
                const daysForThisProduct = Math.min(totalSpotsForProduct, validDays.length);
                const spotsPerDayForProduct = Math.floor(totalSpotsForProduct / daysForThisProduct);
                let remainingSpotsForProduct = totalSpotsForProduct % daysForThisProduct;
                
                console.log(`📊 Produto ${productType}: ${totalSpotsForProduct} spots em ${daysForThisProduct} dias`);
                
                for (let i = 0; i < daysForThisProduct; i++) {
                    const dayIndex = Math.floor((i * validDays.length) / daysForThisProduct);
                    const dateKey = validDays[dayIndex].toISOString().split('T')[0];
                    
                    const spotsForThisDay = spotsPerDayForProduct + (remainingSpotsForProduct > 0 ? 1 : 0);
                    if (remainingSpotsForProduct > 0) remainingSpotsForProduct--;
                    
                    distribution[dateKey].products[productType] = 
                        (distribution[dateKey].products[productType] || 0) + spotsForThisDay;
                    distribution[dateKey].total += spotsForThisDay;
                }
            });
            
            console.log('🎯 Distribuição calculada:', distribution);
            return { distribution, totalSpots };
        }

        function getMonthName(month, year) {
            const months = [
                'Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'
            ];
            return `${months[month]} ${year}`;
        }

        function getMonthCalendar(year, month) {
            const firstDay = new Date(year, month, 1);
            const startCalendar = new Date(firstDay);
            startCalendar.setDate(startCalendar.getDate() - firstDay.getDay());
            
            const days = [];
            const current = new Date(startCalendar);
            
            for (let i = 0; i < 42; i++) {
                days.push(new Date(current));
                current.setDate(current.getDate() + 1);
                
                if (current.getMonth() !== month && current.getDay() === 0 && i > 28) {
                    break;
                }
            }
            
            return days;
        }

        function createBadges(dayData, td) {
            if (!dayData || dayData.total === 0) return;

            const spotsContainer = document.createElement('div');
            spotsContainer.className = 'spots-container';
            
            const badgesContainer = document.createElement('div');
            badgesContainer.className = 'spots-badges';
            
            // Sempre usar badge consolidado único
            const consolidatedBadge = document.createElement('div');
            consolidatedBadge.className = 'consolidated-badge';
            consolidatedBadge.textContent = dayData.total;
            
            // Armazenar dados do dia no badge para o tooltip
            consolidatedBadge.tooltipData = dayData;
            
            badgesContainer.appendChild(consolidatedBadge);
            spotsContainer.appendChild(badgesContainer);
            td.appendChild(spotsContainer);
            
            // Adicionar event listeners diretamente ao badge
            consolidatedBadge.addEventListener('mouseenter', showRichTooltip);
            consolidatedBadge.addEventListener('mouseleave', hideRichTooltip);
            consolidatedBadge.addEventListener('mousemove', updateTooltipPosition);
        }

        function showRichTooltip(e) {
            const badge = e.target;
            const dayData = badge.tooltipData;
            
            if (!dayData) return;
            
            const params = window.currentCampaignData || { pmm: 1000 };
            const pmm = params.pmm || 1000;
            
            // Criar tooltip se não existir
            let tooltip = document.querySelector('.rich-tooltip');
            if (!tooltip) {
                tooltip = document.createElement('div');
                tooltip.className = 'rich-tooltip';
                document.body.appendChild(tooltip);
            }
            
            // Gerar conteúdo do tooltip CORRIGIDO
            let tooltipContent = `📺 Total de inserções: ${dayData.total}\n`;
            tooltipContent += `📊 Impactos total: ${calculateDayImpact(dayData.products, pmm).toLocaleString()}\n\n`;
            tooltipContent += `📋 Detalhamento:\n`;
            
            Object.entries(dayData.products).forEach(([type, count]) => {
                const productName = getProductName(type);
                tooltipContent += `• ${productName}: ${count}\n`;
            });
            
            tooltip.innerHTML = tooltipContent.replace(/\n/g, '<br>');
            tooltip.classList.add('show');
            
            updateTooltipPosition(e);
        }

        function hideRichTooltip() {
            const tooltip = document.querySelector('.rich-tooltip');
            if (tooltip) {
                tooltip.classList.remove('show');
            }
        }

        function updateTooltipPosition(e) {
            const tooltip = document.querySelector('.rich-tooltip');
            if (!tooltip || !tooltip.classList.contains('show')) return;
            
            const rect = e.target.getBoundingClientRect();
            const tooltipRect = tooltip.getBoundingClientRect();
            
            let left = rect.left + rect.width / 2 - tooltipRect.width / 2;
            let top = rect.top - tooltipRect.height - 15;
            
            // Ajustar posição se sair da tela
            if (left < 10) left = 10;
            if (left + tooltipRect.width > window.innerWidth - 10) {
                left = window.innerWidth - tooltipRect.width - 10;
            }
            if (top < 10) top = rect.bottom + 15;
            
            tooltip.style.left = left + 'px';
            tooltip.style.top = top + 'px';
        }

        function createCompactCalendar(startDate, endDate, distribution, selectedWeekdays) {
            console.log('📅 Criando calendário com distribuição:', distribution);
            const container = document.getElementById('calendar-container');
            container.innerHTML = '';
            
            const months = new Set();
            const current = new Date(startDate);
            
            while (current <= endDate) {
                months.add(`${current.getFullYear()}-${current.getMonth()}`);
                current.setMonth(current.getMonth() + 1);
                current.setDate(1);
            }
            
            months.forEach(monthKey => {
                const [year, month] = monthKey.split('-').map(Number);
                const days = getMonthCalendar(year, month);
                
                const monthContainer = document.createElement('div');
                monthContainer.className = 'calendar-compact';
                
                const monthHeader = document.createElement('div');
                monthHeader.className = 'month-header';
                monthHeader.textContent = getMonthName(month, year);
                monthContainer.appendChild(monthHeader);
                
                const table = document.createElement('table');
                table.className = 'calendar-table';
                
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                const weekdays = ['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SÁB'];
                
                weekdays.forEach(day => {
                    const th = document.createElement('th');
                    th.textContent = day;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                const tbody = document.createElement('tbody');
                
                for (let i = 0; i < days.length; i += 7) {
                    const weekDays = days.slice(i, i + 7);
                    const row = document.createElement('tr');
                    
                    weekDays.forEach(day => {
                        const td = document.createElement('td');
                        const isCurrentMonth = day.getMonth() === month;
                        const isDayValid = isDaySelected(day, selectedWeekdays);
                        const dateKey = day.toISOString().split('T')[0];
                        const dayData = distribution[dateKey];
                        
                        const dateCell = document.createElement('div');
                        dateCell.className = 'date-cell';
                        
                        if (isCurrentMonth) {
                            dateCell.classList.add('current-month');
                        }
                        
                        if (isDayValid && isCurrentMonth) {
                            dateCell.classList.add('selected-weekday');
                        }
                        
                        if (dayData && dayData.total > 0) {
                            dateCell.classList.add('has-spots');
                        }
                        
                        const dateNumber = document.createElement('div');
                        dateNumber.className = 'date-number';
                        dateNumber.textContent = day.getDate();
                        dateCell.appendChild(dateNumber);
                        
                        td.appendChild(dateCell);
                        
                        createBadges(dayData, td);
                        
                        row.appendChild(td);
                    });
                    
                    tbody.appendChild(row);
                }
                
                table.appendChild(tbody);
                monthContainer.appendChild(table);
                container.appendChild(monthContainer);
            });
        }

        function updateProductsInfo(activeProducts) {
            console.log('🏷️ Atualizando produtos ativos:', activeProducts);
            const activeProductsElement = document.getElementById('active-products');
            activeProductsElement.innerHTML = '';
            
            Object.entries(activeProducts).forEach(([type, count]) => {
                const tag = document.createElement('span');
                tag.className = `product-tag tag-${type}`;
                tag.textContent = `${getProductName(type)}: ${count}`;
                activeProductsElement.appendChild(tag);
                console.log(`🎨 Tag criada: ${type}`);
            });
            
            document.getElementById('products-info').style.display = 'block';
        }

        function updateWeekdaysInfo(diasStr) {
            const weekdayNames = {
                'Dom.': 'Domingo', 'Seg.': 'Segunda', 'Ter.': 'Terça', 'Qua.': 'Quarta',
                'Qui.': 'Quinta', 'Sex.': 'Sexta', 'Sáb.': 'Sábado'
            };
            
            const selectedNames = diasStr.split(',').map(day => weekdayNames[day.trim()]).filter(Boolean);
            
            document.getElementById('selected-weekdays').textContent = selectedNames.join(', ');
            document.getElementById('weekdays-info').style.display = 'block';
        }

        function updateStats(params, validDays, totalSpots) {
            const startDate = parseDate(params.inicio);
            const endDate = parseDate(params.fim);
            const avgSpots = validDays.length > 0 ? (totalSpots / validDays.length).toFixed(1) : '0';
            
            const periodRange = `${startDate.getDate().toString().padStart(2, '0')}/${(startDate.getMonth() + 1).toString().padStart(2, '0')}-${endDate.getDate().toString().padStart(2, '0')}/${(endDate.getMonth() + 1).toString().padStart(2, '0')}`;
            
            const activeProducts = getActiveProducts(params);
            const pmm = params.pmm || 1000;
            const totalImpact = calculateImpact(activeProducts, pmm);
            
            document.getElementById('total-spots').textContent = totalSpots;
            document.getElementById('total-days').textContent = validDays.length;
            document.getElementById('avg-spots').textContent = avgSpots;
            document.getElementById('period-range').textContent = periodRange;
            document.getElementById('total-impact').textContent = totalImpact.toLocaleString();
            document.getElementById('pmm-used').textContent = pmm.toLocaleString();
            
            console.log(`📊 Período: ${periodRange}`);
            document.getElementById('stats').style.display = 'grid';
        }

        function showExample() {
            const exampleParams = {
                spots30: 15,
                spots5: 8,
                spots15: 12,
                spots60: 5,
                test60: 3,
                emissora: 'EXEMPLO RADIO',
                inicio: '01/11/2025',
                fim: '30/11/2025',
                dias: 'Seg.,Qua.,Sex.',
                pmm: 1000
            };
            
            const startDate = parseDate(exampleParams.inicio);
            const endDate = parseDate(exampleParams.fim);
            const selectedWeekdays = parseSelectedWeekdays(exampleParams.dias);
            const activeProducts = getActiveProducts(exampleParams);
            const totalSpots = Object.values(activeProducts).reduce((sum, spots) => sum + spots, 0);
            
            document.getElementById('title').textContent = exampleParams.emissora + ' (EXEMPLO)';
            document.getElementById('subtitle').textContent = 
                `${formatDate(startDate)} a ${formatDate(endDate)} • ${totalSpots} inserções • Demonstração`;
            
            updateProductsInfo(activeProducts);
            updateWeekdaysInfo(exampleParams.dias);
            
            const validDays = getValidDays(startDate, endDate, selectedWeekdays);
            const { distribution } = distributeMultipleSpots(activeProducts, validDays);
            
            createCompactCalendar(startDate, endDate, distribution, selectedWeekdays);
            updateStats(exampleParams, validDays, totalSpots);
        }

        function showEmptyCalendar(params, startDate, endDate, selectedWeekdays) {
            document.getElementById('title').textContent = params.emissora.toUpperCase();
            document.getElementById('subtitle').textContent = 
                `${formatDate(startDate)} a ${formatDate(endDate)} • Nenhuma inserção programada`;
            
            updateWeekdaysInfo(params.dias);
            
            const validDays = getValidDays(startDate, endDate, selectedWeekdays);
            const emptyDistribution = {};
            
            createCompactCalendar(startDate, endDate, emptyDistribution, selectedWeekdays);
            updateStats(params, validDays, 0);
        }

        function calculateImpact(products, pmm) {
            let totalImpact = 0;
            
            totalImpact += (products.spots30 || 0) * pmm;
            totalImpact += (products.test60 || 0) * (pmm * 2);
            totalImpact += (products.spots60 || 0) * (pmm * 2);
            totalImpact += (products.spots15 || 0) * (pmm / 2);
            totalImpact += (products.spots5 || 0) * (pmm / 6);
            
            return Math.round(totalImpact);
        }

        function calculateDayImpact(dayProducts, pmm) {
            return calculateImpact(dayProducts, pmm);
        }

        // Exportação de dados (função corrigida)
        function exportToExcel() {
            console.log('📊 Iniciando exportação de dados...');
            
            const params = window.currentCampaignData || {};
            const startDate = parseDate(params.inicio || '01/01/2025');
            const endDate = parseDate(params.fim || '31/01/2025');
            const selectedWeekdays = parseSelectedWeekdays(params.dias || 'Seg.,Ter.,Qua.,Qui.,Sex.');
            const activeProducts = getActiveProducts(params);
            const validDays = getValidDays(startDate, endDate, selectedWeekdays);
            const { distribution } = distributeMultipleSpots(activeProducts, validDays);
            const pmm = params.pmm || 1000;
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Data,Dia Semana,Spots 30s,Spots 5s,Spots 15s,Spots 60s,Test 60s,Total Inserções,Impactos PMM\n";
            
            validDays.forEach(day => {
                const dateKey = day.toISOString().split('T')[0];
                const dayData = distribution[dateKey] || { total: 0, products: {} };
                const weekdayName = ['Domingo','Segunda','Terça','Quarta','Quinta','Sexta','Sábado'][day.getDay()];
                const dayImpact = calculateDayImpact(dayData.products, pmm);
                
                const row = [
                    formatDate(day),
                    weekdayName,
                    dayData.products.spots30 || 0,
                    dayData.products.spots5 || 0,
                    dayData.products.spots15 || 0,
                    dayData.products.spots60 || 0,
                    dayData.products.test60 || 0,
                    dayData.total,
                    dayImpact
                ];
                
                csvContent += row.join(",") + "\n";
            });
            
            // Adicionar linha de totais
            const totalSpots = Object.values(activeProducts).reduce((sum, spots) => sum + spots, 0);
            const totalImpact = calculateImpact(activeProducts, pmm);
            csvContent += `\nTOTAL,,${activeProducts.spots30||0},${activeProducts.spots5||0},${activeProducts.spots15||0},${activeProducts.spots60||0},${activeProducts.test60||0},${totalSpots},${totalImpact}\n`;
            csvContent += `PMM Usado,,,,,,,,${pmm}\n`;
            csvContent += `Emissora,,,,,,,,${params.emissora||'N/A'}\n`;
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `distribuicao_midias_${params.emissora||'campanha'}_${formatDate(new Date()).replace(/\//g, '-')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log('📊 Exportação de dados concluída');
        }

        // Nova função para exportar calendário visual (com melhorias e debug)
        function exportCalendarToExcel() {
            console.log('📅 Iniciando exportação de calendário visual...');
            
            try {
                // Verificar se a biblioteca XLSX está carregada
                if (typeof XLSX === 'undefined') {
                    console.error('❌ Biblioteca XLSX não carregada!');
                    alert('Erro: Biblioteca XLSX não disponível. Verifique a conexão com a internet.');
                    return;
                }
                
                const params = window.currentCampaignData || {};
                const startDate = parseDate(params.inicio || '01/01/2025');
                const endDate = parseDate(params.fim || '31/01/2025');
                const selectedWeekdays = parseSelectedWeekdays(params.dias || 'Seg.,Ter.,Qua.,Qui.,Sex.');
                const activeProducts = getActiveProducts(params);
                const validDays = getValidDays(startDate, endDate, selectedWeekdays);
                const { distribution } = distributeMultipleSpots(activeProducts, validDays);
                const pmm = params.pmm || 1000;
                
                console.log('📊 Dados preparados para exportação:', {
                    startDate, endDate, activeProducts, validDays: validDays.length
                });
                
                // Criar workbook
                const wb = XLSX.utils.book_new();
                console.log('📚 Workbook criado');
                
                // Obter meses únicos
                const months = new Set();
                const current = new Date(startDate);
                
                while (current <= endDate) {
                    months.add(`${current.getFullYear()}-${current.getMonth()}`);
                    current.setMonth(current.getMonth() + 1);
                    current.setDate(1);
                }
                
                console.log(`📅 Processando ${months.size} meses:`, Array.from(months));
                
                // Criar uma aba para cada mês
                months.forEach((monthKey, index) => {
                    console.log(`📅 Processando mês ${index + 1}/${months.size}: ${monthKey}`);
                    
                    const [year, month] = monthKey.split('-').map(Number);
                    const monthName = getMonthName(month, year);
                    const days = getMonthCalendar(year, month);
                    
                    // Criar matriz do calendário
                    const calendarData = [];
                    
                    // Cabeçalho do mês
                    calendarData.push([monthName, '', '', '', '', '', '']);
                    calendarData.push(['DOM', 'SEG', 'TER', 'QUA', 'QUI', 'SEX', 'SÁB']);
                    
                    // Processar dias em semanas
                    for (let i = 0; i < days.length; i += 7) {
                        const weekDays = days.slice(i, i + 7);
                        const weekRow = [];
                        
                        weekDays.forEach(day => {
                            const isCurrentMonth = day.getMonth() === month;
                            const dateKey = day.toISOString().split('T')[0];
                            const dayData = distribution[dateKey];
                            
                            if (!isCurrentMonth) {
                                weekRow.push('');
                            } else if (dayData && dayData.total > 0) {
                                // Formato: "15 (5 inserções)"
                                weekRow.push(`${day.getDate()} (${dayData.total})`);
                            } else if (isDaySelected(day, selectedWeekdays)) {
                                // Dia selecionado mas sem inserções
                                weekRow.push(`${day.getDate()}`);
                            } else {
                                // Dia não selecionado
                                weekRow.push(day.getDate().toString());
                            }
                        });
                        
                        calendarData.push(weekRow);
                        
                        // Se já temos uma semana completa do próximo mês, parar
                        if (weekDays.length > 0 && weekDays[weekDays.length - 1].getMonth() !== month) {
                            break;
                        }
                    }
                    
                    // Adicionar informações de resumo
                    calendarData.push(['']);
                    calendarData.push(['RESUMO DO MÊS:']);
                    
                    // Calcular estatísticas do mês
                    let monthSpots = 0;
                    let monthDays = 0;
                    let monthImpact = 0;
                    
                    days.forEach(day => {
                        if (day.getMonth() === month) {
                            const dateKey = day.toISOString().split('T')[0];
                            const dayData = distribution[dateKey];
                            if (dayData && dayData.total > 0) {
                                monthSpots += dayData.total;
                                monthDays++;
                                monthImpact += calculateDayImpact(dayData.products, pmm);
                            }
                        }
                    });
                    
                    calendarData.push([`Total de inserções: ${monthSpots}`]);
                    calendarData.push([`Dias ativos: ${monthDays}`]);
                    calendarData.push([`Impactos PMM: ${monthImpact.toLocaleString()}`]);
                    
                    // Detalhamento por produto
                    calendarData.push(['']);
                    calendarData.push(['PRODUTOS:']);
                    Object.entries(activeProducts).forEach(([type, count]) => {
                        calendarData.push([`${getProductName(type)}: ${count}`]);
                    });
                    
                    // Criar worksheet
                    const ws = XLSX.utils.aoa_to_sheet(calendarData);
                    
                    // Definir larguras das colunas
                    const colWidths = [
                        { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 },
                        { wch: 12 }, { wch: 12 }, { wch: 12 }
                    ];
                    ws['!cols'] = colWidths;
                    
                    // Adicionar worksheet ao workbook
                    const sheetName = monthName.replace(' ', '_');
                    XLSX.utils.book_append_sheet(wb, ws, sheetName);
                    console.log(`✅ Aba criada: ${sheetName}`);
                });
                
                // Criar aba de resumo geral
                console.log('📋 Criando aba de resumo...');
                const summaryData = [];
                summaryData.push(['RESUMO GERAL DA CAMPANHA']);
                summaryData.push(['']);
                summaryData.push(['Emissora:', params.emissora || 'N/A']);
                summaryData.push(['Período:', `${formatDate(startDate)} a ${formatDate(endDate)}`]);
                summaryData.push(['PMM Usado:', pmm.toLocaleString()]);
                summaryData.push(['']);
                
                summaryData.push(['PRODUTOS ATIVOS:']);
                Object.entries(activeProducts).forEach(([type, count]) => {
                    const impact = calculateImpact({[type]: count}, pmm);
                    summaryData.push([getProductName(type), count, impact.toLocaleString()]);
                });
                
                summaryData.push(['']);
                summaryData.push(['TOTAIS:']);
                const totalSpots = Object.values(activeProducts).reduce((sum, spots) => sum + spots, 0);
                const totalImpact = calculateImpact(activeProducts, pmm);
                summaryData.push(['Total de inserções:', totalSpots]);
                summaryData.push(['Dias ativos:', validDays.length]);
                summaryData.push(['Impactos total:', totalImpact.toLocaleString()]);
                summaryData.push(['Média inserções/dia:', validDays.length > 0 ? (totalSpots / validDays.length).toFixed(1) : '0']);
                
                summaryData.push(['']);
                summaryData.push(['DIAS SELECIONADOS:']);
                const weekdayNames = {
                    'Dom.': 'Domingo', 'Seg.': 'Segunda', 'Ter.': 'Terça', 'Qua.': 'Quarta',
                    'Qui.': 'Quinta', 'Sex.': 'Sexta', 'Sáb.': 'Sábado'
                };
                const selectedNames = params.dias.split(',').map(day => weekdayNames[day.trim()]).filter(Boolean);
                selectedNames.forEach(day => {
                    summaryData.push([day]);
                });
                
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                summaryWs['!cols'] = [{ wch: 20 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, summaryWs, 'Resumo', 0);
                console.log('✅ Aba de resumo criada');
                
                // Salvar arquivo
                const fileName = `calendario_${params.emissora||'campanha'}_${formatDate(new Date()).replace(/\//g, '-')}.xlsx`;
                console.log(`💾 Salvando arquivo: ${fileName}`);
                
                XLSX.writeFile(wb, fileName);
                
                console.log('✅ Exportação de calendário concluída com sucesso!');
                
            } catch (error) {
                console.error('❌ Erro na exportação de calendário:', error);
                alert(`Erro ao exportar calendário: ${error.message}`);
            }
        }

        async function init() {
            try {
                const params = getURLParams();
                console.log('🎯 Parâmetros detectados:', params);
                console.log('🔄 Modo de operação:', params.mode);
                
                let campaignData;
                window.currentCampaignData = null;
                
                if (params.mode === 'notion-api') {
                    // Modo dinâmico: buscar dados via API Notion
                    document.getElementById('subtitle').textContent = 'Conectando com Notion...';
                    
                    try {
                        campaignData = await fetchNotionData(params.uuid);
                        console.log('📊 Dados da campanha carregados:', campaignData);
                    } catch (error) {
                        console.error('❌ Erro ao carregar dados:', error);
                        throw new Error(`Erro ao carregar dados do Notion: ${error.message}`);
                    }
                } else {
                    // Modo legado: usar parâmetros da URL
                    campaignData = params;
                    console.log('📋 Usando dados dos parâmetros URL');
                }
                
                // Salvar dados globalmente para funções auxiliares
                window.currentCampaignData = campaignData;
                
                const startDate = parseDate(campaignData.inicio);
                const endDate = parseDate(campaignData.fim);
                const selectedWeekdays = parseSelectedWeekdays(campaignData.dias);
                const activeProducts = getActiveProducts(campaignData);
                
                const totalSpots = Object.values(activeProducts).reduce((sum, spots) => sum + spots, 0);
                const hasParams = params.mode === 'notion-api' || window.location.search.length > 0;
                
                if (!hasParams) {
                    console.log('🎭 Mostrando exemplo');
                    showExample();
                    return;
                }
                
                if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                    throw new Error('Datas inválidas nos dados recebidos');
                }
                
                if (startDate > endDate) {
                    throw new Error('Data de início deve ser anterior à data de fim');
                }
                
                if (selectedWeekdays.length === 0) {
                    throw new Error('Pelo menos um dia da semana deve ser selecionado');
                }
                
                if (totalSpots <= 0) {
                    console.log('📭 Nenhuma inserção programada');
                    showEmptyCalendar(campaignData, startDate, endDate, selectedWeekdays);
                    return;
                }
                
                // Indicar fonte dos dados no título
                const sourceIndicator = params.mode === 'notion-api' ? ' 📡' : '';
                document.getElementById('title').textContent = campaignData.emissora.toUpperCase() + sourceIndicator;
                document.getElementById('subtitle').textContent = 
                    `${formatDate(startDate)} a ${formatDate(endDate)} • ${totalSpots} inserções`;
                
                updateProductsInfo(activeProducts);
                updateWeekdaysInfo(campaignData.dias);
                
                // Mostrar barra de ações
                document.getElementById('actions-bar').style.display = 'flex';
                document.getElementById('campaign-title').textContent = `${campaignData.emissora} • PMM: ${(campaignData.pmm || 1000).toLocaleString()}`;
                
                const validDays = getValidDays(startDate, endDate, selectedWeekdays);
                
                if (validDays.length === 0) {
                    throw new Error('Não há dias válidos no período com os dias da semana selecionados');
                }
                
                const { distribution } = distributeMultipleSpots(activeProducts, validDays);
                
                createCompactCalendar(startDate, endDate, distribution, selectedWeekdays, campaignData);
                updateStats(campaignData, validDays, totalSpots);
                
                console.log('✅ Sistema carregado com sucesso!');
                
            } catch (error) {
                console.error('💥 Erro no sistema:', error);
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('subtitle').textContent = 'Erro ao processar dados da campanha';
            }
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
